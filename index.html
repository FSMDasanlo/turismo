<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Jugadores - Viajar es Saber</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Estilos específicos para la página de gestión de jugadores */
    body.gestion {
      background: url('imagenes/background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
      box-sizing: border-box;
    }

    .header-container {
      background: linear-gradient(135deg, #1a73e8, #0d47a1);
      border-radius: 12px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      width: 100%;
      max-width: 500px;
      padding: 1rem 2rem;
      box-sizing: border-box;
      text-align: center;
      color: white;
      margin-bottom: 1rem;
    }

    .header-container h1 {
      font-size: 2.2rem;
      margin: 0;
      color: white; /* Asegura que el texto del título sea blanco */
    }

    .contenedor-gestion {
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      width: 100%;
      max-width: 500px;
      padding: 2rem;
      box-sizing: border-box;
    }

    .card-jugadores {
      min-height: 100px; /* Asegura que el contenedor tenga espacio aunque esté vacío */
      padding: 0.5rem;
      border: 1px dashed #ccc;
      border-radius: 8px;
    }
    .lista-jugadores li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .borrar-jugador {
      background: none;
      border: none;
      color: #aaa;
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .borrar-jugador:hover { color: #d9534f; }

    .agregar-jugador {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .agregar-jugador input {
      flex-grow: 1;
      padding: 0.7rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .btn-accion {
      padding: 0.7rem;
      font-size: 1.2rem;
      line-height: 1;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
    }

    .btn-add { background-color: #4CAF50; }
    .btn-add:hover { background-color: #45a049; }

    .botones-finales {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .botones-finales button {
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .botones-finales button:hover { transform: scale(1.05); }
    .botones-finales .jugar { background-color: #28a745; color: white; }
    .botones-finales .contrarreloj { background-color: #ff9800; color: white; } /* Naranja para el nuevo modo */

  </style>
</head>
<body class="gestion">
  <header class="header-container">
    <h1>Viajar es Saber</h1>
  </header>

  <main class="contenedor-gestion">
    <div class="agregar-jugador">
      <input type="text" id="nombre-jugador" placeholder="Añadir nuevo jugador..." onkeypress="if(event.key==='Enter') agregarJugador()">
      <button class="btn-accion btn-add" onclick="agregarJugador()" title="Añadir jugador">➕</button>
    </div>

    <div class="card-jugadores">
      <ul id="lista-jugadores" class="lista-jugadores"></ul>
    </div>

    <div class="botones-finales">
      <button class="jugar" onclick="irAlJuego()">Modo normal</button>
      <button class="contrarreloj" onclick="irAlContrarreloj()">Modo contrarreloj</button>
    </div>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        cargarJugadores();
    });

    function agregarJugador() {
        const input = document.getElementById('nombre-jugador');
        const nombre = input.value.trim();

        if (nombre) {
            let jugadores = JSON.parse(localStorage.getItem('jugadores')) || [];
            // ¡CORRECCIÓN CLAVE! Aseguramos que solo trabajamos con jugadores válidos antes de la comprobación.
            jugadores = jugadores.filter(j => 
                typeof j === 'object' && j !== null && typeof j.nombre === 'string'
            );

            // Evitar duplicados
            if (jugadores.some(j => j.nombre.toLowerCase() === nombre.toLowerCase())) { // Esta es la línea 164
                alert('Este jugador ya ha sido añadido.');
                return;
            }

            jugadores.push({ nombre: nombre, puntuacion: 0 });
            localStorage.setItem('jugadores', JSON.stringify(jugadores));
            input.value = '';
            cargarJugadores();
        }
    }

    function cargarJugadores() {
        const lista = document.getElementById('lista-jugadores');
        lista.innerHTML = '';
        let jugadores = [];

        try {
            const jugadoresGuardados = JSON.parse(localStorage.getItem('jugadores'));
            // Nos aseguramos de que lo que cargamos es un array
            if (Array.isArray(jugadoresGuardados)) {
                // Filtramos para asegurar que cada jugador tiene un 'nombre' válido
                jugadores = jugadoresGuardados.filter(j => 
                    typeof j === 'object' && j !== null && typeof j.nombre === 'string'
                );
                localStorage.setItem('jugadores', JSON.stringify(jugadores)); // Guardar la versión limpia
            }
        } catch (e) {
            // Si hay un error al parsear (p.ej. localStorage corrupto), empezamos con un array vacío.
            console.error("Error al cargar jugadores desde localStorage:", e);
            jugadores = [];
        }

        if (jugadores.length === 0) {
            lista.innerHTML = '<p style="text-align: center; color: #888;">Aún no hay jugadores.</p>';
            return;
        }

        jugadores.forEach((jugador, index) => {
            // Ya hemos filtrado los jugadores inválidos, así que podemos asumir que son válidos aquí.
            const li = document.createElement('li');
            
            const spanNombre = document.createElement('span');
            // Aseguramos que el nombre se muestre, incluso si por alguna razón extraña no fuera string
            // Aunque el filtro anterior ya debería haberlo garantizado.
            if (typeof jugador.nombre === 'string') {
                spanNombre.textContent = jugador.nombre;
            } else {
                spanNombre.textContent = '[Nombre Inválido]'; // Fallback por si acaso
            }
            
                const btnBorrar = document.createElement('button');
                btnBorrar.textContent = '×';
                btnBorrar.className = 'borrar-jugador';
                btnBorrar.title = 'Eliminar jugador';
                btnBorrar.onclick = () => borrarJugador(index);

                li.appendChild(spanNombre);
                li.appendChild(btnBorrar);
            lista.appendChild(li);
        });
    }

    function borrarJugador(index) {
        let jugadores = JSON.parse(localStorage.getItem('jugadores')) || [];
        jugadores.splice(index, 1);
        localStorage.setItem('jugadores', JSON.stringify(jugadores));
        cargarJugadores();
    }

    // Lógica para ir al juego
    function irAlJuego() {
      const jugadores = JSON.parse(localStorage.getItem('jugadores')) || [];
      if (jugadores.length < 1) {
        alert('Debes añadir al menos un jugador para empezar.');
        return;
      }
      window.location.href = 'juego.html';
    }

    function irAlContrarreloj() {
      const jugadores = JSON.parse(localStorage.getItem('jugadores')) || [];
      if (jugadores.length < 1) {
        alert('Debes añadir al menos un jugador para el modo contrarreloj.');
        return;
      }
      window.location.href = 'juego.html?modo=contrarreloj';
    }
  </script>
</body>

</html>
